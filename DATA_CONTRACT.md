# 数据契约

## Parser 输出契约
- 输出类型：`dict`，包含汇总表和单个文件表格。
- 键名约定：`combined` 对应合并后的 `DataFrame`；`tables` 对应以文件路径字符串为键、以清洗后的 `DataFrame` 为值的映射。
- 表格形态：行索引为标准化科目名称（去除序号、括注并大写），列名为四位数字年份或原始字段标题的精简文本。
- 值类型：单元格为浮点数，可包含 `NaN` 表示缺失或无法解析。
- 年份规范：列标题中的年份统一提取为 4 位数字（如 `2023`），非年份列保留清洗后的文本。
- 科目名规范：去除空格、编号和括号说明，统一大写，保留中文、英文和数字字符。
- 数值规范：括号包裹的数值视为负数，千分位分隔符被移除，无法转换的值记为 `NaN`。

## Logic 输入与输出契约
- 输入来源：接受 Parser 的 `DataFrame` 或包含科目名称映射到数值序列的 `dict`/映射；科目键需使用 Parser 标准化后的名称。
- 输入依赖字段：基础科目需至少包含 `营业收入`、`归母净利润`、`经营活动产生的现金流量净额`、`货币资金`、`有息负债`；派生计算补充 `资本性支出`、`应收账款`。
- 输出类型：`dict`，分为三类顶级键。
  - `基础指标`：以科目名称为键，值为对应序列的首期数值。
  - `派生指标`：包含 `同比变动率`（按基础指标逐项给出变动率映射）、`自由现金流`、`DSRI` 的汇总结果。
  - `异常标记`：`同比异常`（逐项布尔映射）、`派生异常`（包含 `自由现金流`、`DSRI`、`同比变动率` 组合布尔）用于指出可疑或无效结果。
  - `风险矩阵`：面向专业分析区的规则触发矩阵，采用三态输出（`True`/`False`/`None`），并带有解释原因。
- 值域约定：缺失或不可计算的结果使用 `NaN`，布尔标记只用于指示异常或无效状态，不携带修正值。
- 指标分组：
  - 基础指标：直接来自输入科目首期数值。
  - 派生指标：基于基础及补充科目形成的结构化结果，不暴露中间步骤。
  - 异常标记：针对同比、派生结果的布尔提示，不包含纠正逻辑。

## View 层可依赖内容（前瞻性声明）
- View 只能消费 Logic 的输出结构；不得绕过 Logic 直接读取 Parser 的原始表格或中间状态。
- View 不得假设 Parser 或 Logic 的内部实现细节，如索引顺序、缺失填充策略或计算过程。
- View 必须按照约定字段读取数据；若字段缺失或键名不匹配，应显式报错而非自行推算或补算。
- 专业分析区渲染应基于 `风险矩阵` 结构，不得在 View 层重新计算规则或回退为二态布尔。
